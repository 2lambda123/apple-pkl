// CircleCI build file.
// This file needs to be rendered to `.circleci/config.yml`
// or it won't do anything.
amends "CircleCI.pkl"

import "package://artifacts.apple.com/pkl/pkl/temp.pkl.experimental@1.0.0#/URI.pkl"

version = 2.1

local JAVA_11 = "11.0.20.1+1"

local JAVA_17 = "17.0.8.1+1"

local persistToWorkspace: Step = new {
  persist_to_workspace {
    root = "."
    paths {
      "pkl-cli/build/executable/"
    }
  }
}

local gradleArgs = "--info --stacktrace \(gradleJvmArgs)"

local gradleJvmArgs =
  "'"
  + "-Dorg.gradle.jvmargs="
  + "-Dfile.encoding=UTF-8 "
  + // google-java-format requires jdk.compiler exports
    "--add-exports jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED "
  + "--add-exports jdk.compiler/com.sun.tools.javac.file=ALL-UNNAMED "
  + "--add-exports jdk.compiler/com.sun.tools.javac.parser=ALL-UNNAMED "
  + "--add-exports jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED "
  + "--add-exports jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED"
  + "'"

local function setUpLinuxEnvironment(arch: "amd64"|"aarch64"): StepConfig =
  let (muslVersion = "1.2.2")
  let (zlibVersion = "1.2.13")
//   let (jdkVersionEncoded = URI.encodeComponent(jdkVersion))
//   let (jdkVersionAlt = jdkVersion.replaceLast("+", "_"))
//   let (majorJdkVersion = jdkVersion.split(".").first)
    new {
      run {
        name = "Set up environment"
        command = new Listing {
          #"""
          #!/usr/bin/env bash
          set -eo pipefail

          mkdir -p ~/staticdeps/bin

          # install zlib
          curl -L https://github.com/madler/zlib/releases/download/v\#(zlibVersion)/zlib-\#(zlibVersion).tar.gz -o /tmp/zlib.tar.gz

          mkdir -p /tmp/dep_zlib-\#(zlibVersion) \
          && cd /tmp/dep_zlib-\#(zlibVersion) \
          && cat /tmp/zlib.tar.gz | tar --strip-components=1 -xzC . \
          && echo "zlib-\#(zlibVersion): configure..." && ./configure --static --prefix="$HOME"/staticdeps > /dev/null \
          && echo "zlib-\#(zlibVersion): make..." && make -s -j4 \
          && echo "zlib-\#(zlibVersion): make install..." && make -s install \
          && rm -rf /tmp/dep_zlib-\#(zlibVersion)
          """#
          // don't need musl/libstdc++-static on aarch because GraalVM only supports musl builds on x86
          when (arch == "amd64") {
            #"""
            # install libstdc++ static
            sudo apt-get update
            sudo apt-get install libstdc++10-dev
            cp /usr/lib/gcc/x86_64-linux-gnu/10/libstdc++.a ~/staticdeps

            # install musl
            curl -L https://musl.libc.org/releases/musl-\#(muslVersion).tar.gz -o /tmp/musl.tar.gz

            mkdir -p /tmp/dep_musl-\#(muslVersion) \
            && cd /tmp/dep_musl-\#(muslVersion) \
            && cat /tmp/musl.tar.gz | tar --strip-components=1 -xzC . \
            && echo "musl-\#(muslVersion): configure..." && ./configure --disable-shared --prefix="$HOME"/staticdeps > /dev/null \
            && echo "musl-\#(muslVersion): make..." && make -s -j4 \
            && echo "musl-\#(muslVersion): make install..." && make -s install \
            && rm -rf /tmp/dep_musl-\#(muslVersion)

            # native-image expects to find an executable at this path.
            ln -s ~/staticdeps/bin/musl-gcc ~/staticdeps/bin/x86_64-linux-musl-gcc
            """#
          }
        }.join("\n\n")
      }
    }

local restoreGradleCache: StepConfig = new {
  restore_cache {
    name = "Restore Gradle Dependencies Cache"
    key = "gradle-dependencies-{{ checksum \"gradle/libs.versions.toml\" }}"
  }
}

local saveToGradleCache: StepConfig = new {
  save_cache {
    name = "Save Gradle Dependencies Cache"
    key = "gradle-dependencies-{{ checksum \"gradle/libs.versions.toml\" }}"
    paths {
      "~/.gradle/caches/modules-2/files-2.1/"
    }
  }
}

local function buildLinuxNativeImage(arch: "amd64"|"aarch64", gradleCommand: String): Job = new {
  docker {
    new {
      image = "cimg/openjdk:11.0"
    }
  }
  resource_class = if (arch == "arm64") "arm.large" else "large"
  steps {
    "checkout"
    restoreGradleCache
    setUpLinuxEnvironment(arch)
    // hack to get more RAM in docker
    new {
      setup_remote_docker {
        version = "20.10.14"
        docker_layer_cacheing = true
      }
    }
    gradle(gradleCommand)
    saveToGradleCache
    persistToWorkspace
  }
}

jobs {
  ["build-linux-amd64"] = buildLinuxNativeImage("amd64", "pkl-cli:linuxExecutableAmd64")
  ["build-linux-arm64"] = buildLinuxNativeImage("aarch64", "pkl-cli:linuxExecutableAarch64")
  ["build-linux-alpine-amd64"] = buildLinuxNativeImage("aarch64", "pkl-cli:alpineExecutableAmd64")
  ["build-macos-amd64"] {
    macos {
      xcode = "14.0.0"
    }
    steps {
      "checkout"
      restoreGradleCache
      gradle("buildNative")
      saveToGradleCache
      persistToWorkspace
    }
  }
//   ["dev-jdk11"] {
//     docker {
//       image("cimg/openjdk:11.0")
//     }
//     steps {
//       "checkout"
//       gradle("build")
//       new {
//         store_test_results {
//           path = "./pkl-core/build/test-results/"
//         }
//       }
//     }
//   }
//   ["dev-jdk17"] {
//     docker {
//       image("cimg/openjdk:17.0")
//     }
//     steps {
//       "checkout"
//       gradle("build")
//     }
//   }
//   ["dev-bench"] {
//     docker {
//       image("cimg/openjdk:11.0")
//     }
//     steps {
//       "checkout"
//       gradle("jmh")
//     }
//   }
//   ["dev-gradle-compatibility"] {
//     docker {
//       image("cimg/openjdk:11.0")
//     }
//     steps {
//       "checkout"
//       gradle(":pkl-gradle:build :pkl-gradle:compatibilityTestReleases :pkl-gradle:compatibilityTestCandidate")
//     }
//   }
}

workflows {
//   ["prb"] {
//     jobs {
//       "dev-jdk11"
//       "dev-jdk17"
//       "dev-bench"
//       // we should use linux instead of mac as it's much cheaper
//       "build-macos-amd64"
//       // disabling gradle-compatibility for now because there's some failling tests (also failing on rio)
//       // "dev-gradle-compatibility"
//     }
//   }
// runs out of memory on the free large tier

  ["build-native-images"] {
    jobs {
//       new {
//         ["build-linux-arm64"] {
//           filters {
//             branches {
//               only = "main"
//             }
//           }
//         }
//       }
      new {
        ["build-linux-amd64"] {
          filters {
            branches {
              only = "main"
            }
          }
        }
      }
      new {
        ["build-linux-alpine-amd64"] {
          filters {
            branches {
              only = "main"
            }
          }
        }
      }
      new {
        ["build-macos-amd64"] {
          filters {
            branches {
              only = "main"
            }
          }
        }
      }
    }
  }
}

local function gradle(args: String): StepConfig = new {
  run {
    name = "gradle \(args)"
    command = """
      export PATH=~/staticdeps/bin:$PATH
      ./gradlew \(gradleArgs) \(args)
      """
  }
}
